<template>
  <div>
    <Table
      v-model:formData="formData"
      :page="page"
      :pageSizes="pageSizes"
      :showIndex="true"
      :showPage="false"
      :tableData="tableData"
      @refresh="getDistributorList"
    >
      <template #formItem>
        <!-- <el-form-item :label="t('permission.distributors.name')"
          ><el-input v-model="formData.name"
        /></el-form-item>
        <el-form-item :label="t('permission.distributors.enName')"
          ><el-input v-model="formData.enName"
        /></el-form-item> -->
        <el-form-item>
          <el-button type="success" @click="handleAdd">{{
            t("status.add")
          }}</el-button></el-form-item
        >
      </template>
      <template #columns>
        <el-table-column prop="name" :label="t('permission.role.name')" />
        <el-table-column
          prop="roleName"
          :label="t('permission.role.roleName')"
        />
        <el-table-column prop="desc" :label="t('permission.role.desc')" />

        <el-table-column :label="t('status.operate')">
          <template #default="{ row }">
            <el-button type="primary" @click="handlePermission">{{
              t("permission.role.permission")
            }}</el-button>
            <el-button type="primary" @click="handleEdit(row)">{{
              t("status.edit")
            }}</el-button>
            <el-button type="danger" @click="handleDel(row)">{{
              t("status.del")
            }}</el-button>
          </template>
        </el-table-column>
      </template>
    </Table>

    <Dialog :dialog="dialog" @confirm="submitEdit">
      <el-form ref="ruleForm" :model="editFormData" :rules="rules">
        <el-form-item :label="t('permission.role.name')" prop="name">
          <el-input v-model="editFormData.name"
        /></el-form-item>
        <el-form-item :label="t('permission.role.desc')" prop="desc">
          <el-input v-model="editFormData.desc"
        /></el-form-item>
        <el-form-item
          v-if="dialog.title == `${t('permission.role.addTitle')}`"
          :label="t('permission.role.permission')"
          prop="resourceIdList"
        >
          <el-tree
            ref="tree"
            class="tree"
            style="max-width: 600px"
            :data="filterOptions"
            show-checkbox
            node-key="id"
            :default-expand-all="true"
            :default-checked-keys="checkedList"
            :props="{ children: 'childrenList', label: 'name' }"
            @check-change="handleCheckChange"
          />
        </el-form-item>
      </el-form>
    </Dialog>
  </div>
</template>

<script setup>
import { onMounted, ref, reactive } from "vue";
import Table from "@/components/table/index.vue";
import { useI18n } from "vue-i18n";
import {
  getAllRoleNameList,
  updateRoleInfoById,
  addRoleAndDistributionResource
} from "@/api/permission/role";

const { t } = useI18n();

//获取角色列表
const tableData = ref([]);
const getRoleList = () => {
  getAllRoleNameList().then(res => {
    if (res.success) {
      tableData.value = res.data;
    }
  });
};

//修改角色基础信息
const dialog = reactive({
  show: false,
  title: t("permission.role.editInfo"),
  width: "50%"
});
const editFormData = ref({});
const handleEdit = row => {
  dialog.show = true;
  dialog.title = t("permission.role.editInfo");
  editFormData.value = row;
};
const ruleForm = ref(null);
const rules = {
  name: [
    {
      required: true,
      message: t("permission.role.nameReg"),
      trigger: "blur"
    }
  ],
  resourceIdList: [
    {
      required: true,
      message: t("permission.role.permissionReg"),
      trigger: "change"
    }
  ]
};

//新增
const handleAdd = () => {
  dialog.show = true;
  dialog.title == t("permission.role.addTitle");
  editFormData.value = {};
};

//提交
const submitEdit = () => {
  if (dialog.title == t("permission.role.editInfo")) {
    updateRoleInfoById(editFormData.value).then(res => {
      if (res.success) {
        ElMessage.success(t("status.pureSuccess"));
        dialog.show = false;
        getRoleList();
      }
    });
  } else if (dialog.title == t("permission.role.addTitle")) {
    if (ruleForm.value) {
      ruleForm.value.validate(valid => {
        if (valid) {
          addRoleAndDistributionResource(editFormData.value).then(res => {
            if (res.success) {
              ElMessage.success(t("status.pureSuccess"));
              dialog.show = false;
              getRoleList();
            }
          });
        }
      });
    }
  }
};

onMounted(() => {
  getRoleList();
});
</script>

<style lang="scss" scoped></style>
